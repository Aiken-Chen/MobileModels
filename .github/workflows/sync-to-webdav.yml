name: Sync MD Files to WebDAV (cURL Ultimate Version)

on:
  schedule:
    # 每天在北京时间早上 2 点左右自动运行 (UTC 18:00)
    - cron: '0 18 * * *'
  workflow_dispatch: # 允许手动触发

jobs:
  sync-and-upload:
    runs-on: ubuntu-latest
    steps:
      # 步骤 1: 从原始仓库拉取最新代码
      - name: Checkout Source Repo
        uses: actions/checkout@v4
        with:
          repository: 'KHwang9883/MobileModels'
          path: 'source_repo'

      # 步骤 2: 使用 curl 创建目录并循环上传所有 .md 文件
      - name: Create remote directory and upload files via cURL
        run: |
          # --- ⬇️ 您唯一需要修改的地方 ⬇️ ---
          # !! 请将这里的路径修改为您网盘上的目标文件夹 !!
          # 例如 "dav/files/brands" (注意：路径前后不要加斜杠)
          TARGET_DIR="brands"
          # --- ⬆️ 修改结束 ⬆️ ---

          # 1. 确保基础 URL 后面没有斜杠，以避免双斜杠问题
          BASE_URL=$(echo "${{ secrets.WEBDAV_URL }}" | sed 's:/*$::')

          # 2. 创建远程目录 (如果不存在的话)
          echo "Creating remote directory ${BASE_URL}/${TARGET_DIR}/"
          curl --fail -u "${{ secrets.WEBDAV_USER }}:${{ secrets.WEBDAV_PASS }}" \
               -X MKCOL "${BASE_URL}/${TARGET_DIR}/" || echo "Directory already exists or could not be created."

          # 3. 进入包含 .md 文件的本地目录
          cd ./source_repo/brands/

          # 4. 循环上传每一个 .md 文件
          for file in *.md; do
            echo "Uploading $file..."
            curl --fail -u "${{ secrets.WEBDAV_USER }}:${{ secrets.WEBDAV_PASS }}" \
                 -T "$file" \
                 "${BASE_URL}/${TARGET_DIR}/${file}"
          done
