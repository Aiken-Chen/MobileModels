name: Sync MD Files to WebDAV (cURL Ultimate Version)

on:
  schedule:
    # 每天北京时间 02:00 运行 (UTC 18:00)
    - cron: '0 18 * * *'
  workflow_dispatch: # 允许手动点按钮触发

jobs:
  sync-and-upload:
    runs-on: ubuntu-latest
    steps:
      # 1. 拉取代码
      - name: Checkout Source Repo
        uses: actions/checkout@v4
        with:
          repository: 'KHwang9883/MobileModels'
          path: 'source_repo'

      # 2. 上传到 WebDAV (增强版：带重试和超时控制)
      - name: Create remote directory and upload files via cURL
        run: |
          # --- 配置 ---
          # 你的网盘目标文件夹名称
          TARGET_DIR="brands"
          # -----------

          # 处理 URL，去掉末尾斜杠防止拼接错误
          BASE_URL=$(echo "${{ secrets.WEBDAV_URL }}" | sed 's:/*$::')

          # A. 创建远程目录 (带超时保护)
          echo "Creating remote directory ${BASE_URL}/${TARGET_DIR}/"
          curl -u "${{ secrets.WEBDAV_USER }}:${{ secrets.WEBDAV_PASS }}" \
               --connect-timeout 20 \
               --max-time 60 \
               -X MKCOL "${BASE_URL}/${TARGET_DIR}/" || echo "Directory check passed."

          # B. 进入本地目录
          cd ./source_repo/brands/

          # C. 循环上传 (关键：增加重试机制防止 exit code 28)
          for file in *.md; do
            echo "Uploading $file..."
            curl --fail \
                 --retry 3 \
                 --retry-delay 5 \
                 --connect-timeout 30 \
                 --max-time 180 \
                 -u "${{ secrets.WEBDAV_USER }}:${{ secrets.WEBDAV_PASS }}" \
                 -T "$file" \
                 "${BASE_URL}/${TARGET_DIR}/${file}"
          done
